<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>RPK</title>
<style>
input[type="number"] {
    width: 40px;
}
</style>
<script>
var datas = []
document.addEventListener('DOMContentLoaded', init);
function init() {
    load();
    updateView();
    function $(id) {
        return document.getElementById(id);
    }
    $("new-button").addEventListener('click', function(e) {
        datas.push({
            startBalls: 0,
            startRolls: 0,
            endBalls: 0,
            endRolls: 0,            
        });
        updateView();        
        save();
    });  
    document.body.addEventListener('click', function(e) {
        if(e.target.id.startsWith('remove')) {
            var id = e.target.id;
            var splits = id.split("-");
            if(splits.length != 2) { return; }
            var index = Number(splits[1]);
            datas.splice(index, 1); 
            updateView();
            save();
        }
    });
    document.body.addEventListener('change', function(e) {
        var value = e.target.value;
        num = Number(value)
        if(isNaN(num)) {
            console.log("not number");
            updateView();
            return;
        }
        intNum = parseInt(num);
        if(num !== intNum) {
            console.log("not integer");
            updateView();
            return;
        }        

        id = e.target.id;
        splits = id.split('-');
        if(splits.length !== 2) {
            return;
        }
        var index = Number(splits[1]);
        var prop = splits[0];
        datas[index][prop] = num;
        updateView();
        save();
    });
}
function save() {
    localStorage.setItem('rpk-key', JSON.stringify(datas));
}
function load() {
    var json = localStorage.getItem('rpk-key');
    if(json) {
        datas = JSON.parse(json);
    }
}
function updateView() {
    function $(id) {
        return document.getElementById(id);
    }
    // Update RPK (roll per 1k)
    var sumBalls = 0, sumRolls = 0;
    for(i = 0; i < datas.length; i += 1) {
        data = datas[i];
        if(data.endBalls > data.startBalls) { continue; }
        if(data.endRolls < data.startRolls) { continue; }
        sumBalls += data.startBalls - data.endBalls;
        sumRolls += data.endRolls - data.startRolls;
    }
    var rpkText = "None";
    if(sumBalls > 0) {
        rpkText = (sumRolls / sumBalls * 250).toFixed(2);
    }
    $('rpk-span').innerText = rpkText;

    // Update List
    var html = "";
    for(i = datas.length - 1; i >= 0; i -= 1) {
        data = datas[i];
        html += '<div>';
        html += '<input id="startBalls-' + i + '" type="number" value="' + data.startBalls + '">&nbsp;';
        html += '<input id="startRolls-' + i + '" type="number" value="' + data.startRolls + '">&nbsp;';
        html += '<input id="endBalls-' + i + '" type="number" value="' + data.endBalls + '">&nbsp;';
        html += '<input id="endRolls-' + i + '" type="number" value="' + data.endRolls + '">&nbsp;';
        html += '<input id="remove-' + i + '" type="button" value="Remove">&nbsp;';
        html += '</div>';
    }
    $('data-area').innerHTML = html;
}
</script>
</head>
<body>
    Roll Per 1K v1.0<br>
    <div id="top-area">
        <span id="rpk-span"></span>
        <input id="new-button" type="button" value="New">    
    </div>
    <div id="data-area">
    </div>
</body>
</html>