<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>RPK</title>
<style>
input[type="number"].balls {
    width: 40px;
}
input[type="number"].rolls {
    width: 32px;
}
</style>
<script>
var datas = []
document.addEventListener('DOMContentLoaded', init);

function init() {
    load();
    updateView();
    function $(id) {
        return document.getElementById(id);
    }

    // Attach Events
    $("new-button").addEventListener('click', function(e) {
        datas.push({
            startBalls: 0,
            startRolls: 0,
            endBalls: 0,
            endRolls: 0,            
        });
        updateView();        
        save();
    });
    $("reset-button").addEventListener('click', function(e) {
        if(window.confirm("Do you really want to reset?")) {
            datas = [];
            updateView();        
            save();
        }        
    });  
    document.body.addEventListener('click', function(e) {
        function getIndexById(id) {
            var splits = id.split("-");
            if(splits.length != 2) { return -1; }
            return Number(splits[1]);
        }
        if(e.target.id.startsWith('remove')) {
            if(window.confirm("Do you really want to remove?")) {
                var index = getIndexById(e.target.id);
                if(index < 0) { return; }
                // Remove
                datas.splice(index, 1); 
                updateView();
                save();
            }
        } else if(e.target.id.startsWith('copy')) {
            var index = getIndexById(e.target.id);
            if(index < 0) { return; }
            // Copy
            datas[index].endBalls = datas[index].startBalls; 
            datas[index].endRolls = datas[index].startRolls; 
            updateView();
            save();
        }
    });
    document.body.addEventListener('change', function(e) {
        var value = e.target.value;
        num = Number(value)
        if(isNaN(num)) {
            console.log("not number");
            updateView();
            return;
        }
        intNum = parseInt(num);
        if(num !== intNum) {
            console.log("not integer");
            updateView();
            return;
        }        

        id = e.target.id;
        splits = id.split('-');
        if(splits.length !== 2) {
            return;
        }
        var index = Number(splits[1]);
        var prop = splits[0];
        datas[index][prop] = num;
        updateView();
        save();
    });
}
function save() {
    localStorage.setItem('rpk-key', JSON.stringify(datas));
}
function load() {
    var json = localStorage.getItem('rpk-key');
    if(json) {
        datas = JSON.parse(json);
    }
}
function updateView() {
    function $(id) {
        return document.getElementById(id);
    }
    // Update RPK (roll per 1k)
    var sumBalls = 0, sumRolls = 0;
    for(i = 0; i < datas.length; i += 1) {
        data = datas[i];
        if(data.endBalls > data.startBalls) { continue; }
        if(data.endRolls < data.startRolls) { continue; }
        sumBalls += data.startBalls - data.endBalls;
        sumRolls += data.endRolls - data.startRolls;
    }
    var rpkText = "-";
    if(sumBalls > 0) {
        rpkText = (sumRolls / sumBalls * 250).toFixed(2);
        rpkText += ' (' + sumBalls + ')';
    }
    $('rpk-span').innerText = rpkText;

    // Update List
    var html = "";
    for(i = datas.length - 1; i >= 0; i -= 1) {
        data = datas[i];
        html += '<div>';
        diffBalls = data.startBalls - data.endBalls;
        diffRolls = data.endRolls - data.startRolls;
        var rpkText = "-";
        if(diffRolls >= 0 && diffBalls > 0) {
            rpkText = (diffRolls / diffBalls * 250).toFixed(2);
            rpkText += ' (' + diffBalls + ')';
        }
        html += '<span>' + rpkText + '</span>&nbsp;';
        html += '<input id="startBalls-' + i + '" class="balls" type="number" value="' + data.startBalls + '">&nbsp;';
        html += '<input id="startRolls-' + i + '" class="rolls" type="number" value="' + data.startRolls + '">&nbsp;';
        html += '<input id="endBalls-' + i + '" class="balls" type="number" value="' + data.endBalls + '">&nbsp;';
        html += '<input id="endRolls-' + i + '" class="rolls" type="number" value="' + data.endRolls + '">&nbsp;';
        html += '<input id="copy-' + i + '" type="button" value="Copy">&nbsp;';
        html += '<input id="remove-' + i + '" type="button" value="Remove">&nbsp;';
        html += '</div>';
    }
    $('data-area').innerHTML = html;
}
</script>
</head>
<body>
    Roll Per 1K v1.1<br>
    <div id="top-area">
        <span id="rpk-span"></span>&nbsp;
        <input id="new-button" type="button" value="New">&nbsp;
        <input id="reset-button" type="button" value="Reset">    
    </div>
    <div id="data-area">
    </div>
</body>
</html>